
<!DOCTYPE html>
<html>
<head>
    <title>Robert Moses Game</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

    <link rel="stylesheet" href="style.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/leaflet/1.0.0-rc.1/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/leaflet/1.0.0-rc.1/leaflet-src.js"></script>

    <script src="https://cdn.jsdelivr.net/leaflet.esri/2.0.0-beta.8/esri-leaflet.js"></script>

</head>
<body>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/leaflet.esri.geocoder/2.0.2/esri-leaflet-geocoder.css">
    <script src="https://cdn.jsdelivr.net/leaflet.esri.geocoder/2.0.2/esri-leaflet-geocoder.js"></script>

    <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js'></script>
    <link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css' rel='stylesheet' />

    <script src="js/leaflet.curve.js"></script>
    <script src='js/leaflet-heat.js'></script>
    <script src='js/leaflet.label.js'></script>
    <script src='js/leaflet.polylineoffset.js'></script>
    <script src='js/leaflet-pip.js'></script>
    <script src='js/turf.min.js'></script>
    <script src='js/spline.js'></script>
    <script src='js/bezier.js'></script>
    
    <script src='js/subway-settings.js'></script>
    <script src='js/subway-utils.js'></script>
    <script src='js/subway-files.js'></script>
    <script src='js/subway-id-generator.js'></script>
    <script src='js/subway-station.js'></script>
    <script src='js/subway-line.js'></script>
    <script src='js/subway-transfer.js'></script>
    <script src='js/subway-geocoding.js'></script>
    <script src='js/subway-map-events.js'></script>
    <script src='js/subway-data.js'></script>
    
    

    <!-- Learn about this code on MDN: https://developer.mozilla.org/en-US/docs/Using_files_from_web_applications -->

    <input type="file" id="fileElem" multiple accept="image/*" style="display:none" onchange="handle_files(this.files)">


    <div id="map">
    </div>
    <div id="options">
    Select a Line<br />
    <div class="subway-line-group">
        <div class="subway-line subway-clickable subway-blue subway-selected"><div class="height_fix"></div><div class="content">A</div></div>
        <div class="subway-line subway-clickable subway-blue"><div class="height_fix"></div><div class="content">C</div></div>
        <div class="subway-line subway-clickable subway-blue"><div class="height_fix"></div><div class="content">E</div></div>
    </div>
    <div class="subway-line-group">
        <div class="subway-line subway-clickable subway-orange"><div class="height_fix"></div><div class="content">B</div></div>
        <div class="subway-line subway-clickable subway-orange"><div class="height_fix"></div><div class="content">D</div></div>
        <div class="subway-line subway-clickable subway-orange"><div class="height_fix"></div><div class="content">F</div></div>
        <div class="subway-line subway-clickable subway-orange"><div class="height_fix"></div><div class="content">M</div></div>
    </div>
    <div class="subway-line-group">
        <div class="subway-line subway-clickable subway-light-green"><div class="height_fix"></div><div class="content">G</div></div>
    </div>
    <div class="subway-line-group">
        <div class="subway-line subway-clickable subway-brown"><div class="height_fix"></div><div class="content">J</div></div>
        <div class="subway-line subway-clickable subway-brown"><div class="height_fix"></div><div class="content">Z</div></div>
    </div>
    <div class="subway-line-group">
        <div class="subway-line subway-clickable subway-silver"><div class="height_fix"></div><div class="content">L</div></div>
    </div>
    <div class="subway-line-group">
        <div class="subway-line subway-clickable subway-yellow"><div class="height_fix"></div><div class="content">N</div></div>
        <div class="subway-line subway-clickable subway-yellow"><div class="height_fix"></div><div class="content">Q</div></div>
        <div class="subway-line subway-clickable subway-yellow"><div class="height_fix"></div><div class="content">R</div></div>
    </div>
    <div class="subway-line-group">
        <div class="subway-line subway-clickable subway-gray subway-shuttle" id="S-1"><div class="height_fix"></div><div class="content">S</div></div>
        <div class="subway-line subway-clickable subway-gray subway-shuttle subway-shuttle-add" id="S-2"><div class="height_fix"></div><div class="content">+</div></div>
    </div>
    <div class="subway-line-group">
        <div class="subway-line subway-clickable subway-red"><div class="height_fix"></div><div class="content">1</div></div>
        <div class="subway-line subway-clickable subway-red"><div class="height_fix"></div><div class="content">2</div></div>
        <div class="subway-line subway-clickable subway-red"><div class="height_fix"></div><div class="content">3</div></div>
    </div>
    <div class="subway-line-group">
        <div class="subway-line subway-clickable subway-green"><div class="height_fix"></div><div class="content">4</div></div>
        <div class="subway-line subway-clickable subway-green"><div class="height_fix"></div><div class="content">5</div></div>
        <div class="subway-line subway-clickable subway-green"><div class="height_fix"></div><div class="content">6</div></div>
    </div>
    <div class="subway-line-group">
        <div class="subway-line subway-clickable subway-purple"><div class="height_fix"></div><div class="content">7</div></div>
    </div>
    <div class="subway-line-group">
        <div class="subway-line subway-clickable subway-blue"><div class="height_fix"></div><div class="content">SI</div></div>
    </div>
    <div class="subway-line-group">
        <div class="subway-line subway-clickable subway-light-yellow" id="subway-airtrain"><div class="height_fix"></div><div class="content">&#9992;</div></div>
    </div>
    <div class="subway-line-group">
        <div class="subway-line subway-clickable subway-imaginary subway-turquoise"><div class="height_fix"></div><div class="content">T</div></div>
        <div class="subway-line subway-clickable subway-imaginary subway-black"><div class="height_fix"></div><div class="content">BQX</div></div>
    </div>
    
    <div id="additional-options">
    </div>

    <div id="route-diagram">
    </div>

    </div>


    <div id="system-status">
        <div id="metrocard">
        <i class="fa fa-credit-card" aria-hidden="true"></i>
        <span id="metrocard-cost"></span>
        </div>
        <div id="ridership">
        <i class="fa fa-user" aria-hidden="true"></i>
        <span id="system-ridership"></span>
        </div>
        <div id="game-load" class="game-button">Load</div>
        <div id="game-save" class="game-button">Save</div>
    </div>

    <script>

    var mapbox_token = 'pk.eyJ1IjoianB3cmlnaHQwIiwiYSI6ImNpbjZ1Y212aTA2dGR1ZGtzNHNxZWRkdjIifQ.OgGN3EIjNNB8JsbNRXqqAg';

    var station_layer = L.featureGroup();
    var curve_layer = L.featureGroup();

    var map = L.map('map', {
        fullscreenControl: true,
    }).setView([40.713, -74.006], 13);

    curve_layer.setZIndex(2).addTo(map);
    station_layer.setZIndex(3).addTo(map);

    map.addLayer(curve_layer);
    map.addLayer(station_layer);

    //L.control.scale().addTo(map);

    var tiles = L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token='+mapbox_token, {
        maxZoom: 18,
        minZoom: 12,
        attribution: '',
        id: 'mapbox.light'
    }).addTo(map);

    var neighborhoods = new L.geoJson();
    //neighborhoods.addTo(map);

    $.ajax({
        dataType: "json",
        url: "geojson/neighborhoods.geojson",
        success: function(data) {
            $(data.features).each(function(key, data) {
                neighborhoods.addData(data);
            });
        }
    }).error(function() {});

    var landmarks = new L.geoJson();
    //landmarks.addTo(map);

    $.ajax({
        dataType: "json",
        url: "geojson/landmarks.geojson",
        success: function(data) {
            $(data.features).each(function(key, data) {
                landmarks.addData(data);
            });
        }
    }).error(function() {});

    var tracts = new L.geoJson();
    var tracts_layers;
    var turf_polygons = {};

    var population_heat = L.heatLayer([], {radius: 30, max: 0.5, blur: 50}).addTo(map),
        draw = true;

    var tract_centroids = {};
    var tract_nearby = {};

    var demand = [];
    $.getJSON( "json/demand.json", function( data ) {
        demand = data;
    });
    
    var transfer_state = 0;
    var transfer_origin = -1;
    var transfer_end = -1;

    function newShuttleTemplate(num) {
        return '<div class="subway-line subway-clickable subway-gray subway-shuttle subway-shuttle-add" id="S-'+num.toString()+'"><div class="height_fix"></div><div class="content">+</div></div>'
    }

    

    $(document).on('click', '.subway-clickable', function() {
        line_select_click_handler($(this));
        return false;
    });

    $('#game-save').click(function() {
        //generateGameJSON();
        save_game_json();
    });

     $('#game-load').click(function(e) {
        if (fileElem) {
            fileElem.click();
        }
        e.preventDefault(); // prevent navigation to "#"
    });

    function generate_route_diagram(line) {
        var line_stations = line.stations;
        $('#route-diagram').empty();
        for (var i = 0; i < line_stations.length; i++) {
        
            var line_transfers = [];
            var station = N_stations[line_stations[i]];
            var station_entry = '<div class="route-diagram-entry"><div class="route-diagram-name">'+station.name+'</div><div class="route-diagram-transfers">';
            for (var j = 0; j < station.lines.length; j++) {
                if (N_lines[station.lines[j]].id != line.id)
                    line_transfers.push(station.lines[j]);
            }
            
            for (var k = 0; k < N_transfers.length; k++) {
                var transfers_exist = false;
                if (station.id == N_transfers[k].origin) {
                    var transfer_station = N_transfers[k].end;
                    transfers_exist = true;
                }
                if (station.id == N_transfers[k].end) {
                    var transfer_station = N_transfers[k].origin;
                    transfers_exist = true;
                }
                
                if (transfers_exist) {
                    for (var m = 0; m < N_stations[transfer_station].lines.length; m++) {
                        if (!is_in_array(N_stations[transfer_station].lines[m], line_transfers))
                            line_transfers.push(N_stations[transfer_station].lines[m]);
                    }
                }
            }
            
            for (var q = 0; q < line_transfers.length; q++) {
                station_entry += '<div class="subway-line-mini '+N_lines[line_transfers[q]].css+'"><div class="height_fix"></div><div class="content">'+N_lines[line_transfers[q]].html+'</div></div>';
            }
                
            station_entry += '</div></div>';
            $('#route-diagram').append(station_entry);
        }
    }

    function regenerate_popups() {
        
        for (var i = 0; i < N_stations.length; i++) {
            var station = N_stations[i];
            if (station.active)
                station.generate_popup();
        }
        
    }

    $(document).on('click', '.station-delete', delete_station_event);
    
    $(document).on('click', '.station-transfer', transfer_station_event);

    $(document).on('click', '.station-build', build_to_station_event);


    $(document).on('click', '.station-name', function() {
        var text = $(this).text();
        var sn = $(this);
        $(this).text('');
        $('<textarea class="station-name-edit"></textarea>').appendTo($(this)).val(text).select().blur(

        function() {
            var newText = $(this).val();
            $(this).parent().text(newText).find('textarea').remove();
            var station_id = sn.attr('id').replace('station-', '');
            var station = N_stations[station_id];
            station.name = newText;
            station.generate_popup();
            generate_route_diagram(N_active_line);
        });
    });

    var number_of_shuttles = 0;

    function initialize_game_state() {
    
        if (N_stations != null) {
            // Reset the map
            for (var i = 0; i < N_stations.length; i++) {
                N_stations[i].delete();
            }
        }
        
        if (N_lines != null) {
            for (var j = 0; j < N_lines.length; j++) {
                N_lines[j].generate_draw_map();
            }
            for (j = 0; j < N_lines.length; j++) {
                N_lines[j].draw();
            }
        }

        number_of_shuttles = 1;
        
        station_id_generator.reset();
        line_id_generator.reset();

        N_stations = [];
        N_lines = [];
        N_transfers = [];

        N_lines.push(new Line('A', 'A', 'subway-blue', '#0039A6', '#FFFFFF'));
        N_lines.push(new Line('B', 'B', 'subway-orange', '#FF6319', '#FFFFFF'));
        N_lines.push(new Line('C', 'C', 'subway-blue', '#0039A6', '#FFFFFF'));
        N_lines.push(new Line('D', 'D', 'subway-orange', '#FF6319', '#FFFFFF'));
        N_lines.push(new Line('E', 'E', 'subway-blue', '#0039A6', '#FFFFFF'));
        N_lines.push(new Line('F', 'F', 'subway-orange', '#FF6319', '#FFFFFF'));
        N_lines.push(new Line('G', 'G', 'subway-light-green', '#6CBE45', '#FFFFFF'));
        N_lines.push(new Line('J', 'J', 'subway-brown', '#996633', '#FFFFFF'));
        N_lines.push(new Line('L', 'L', 'subway-silver', '#A7A9AC', '#FFFFFF'));
        N_lines.push(new Line('M', 'M', 'subway-orange', '#FF6319', '#FFFFFF'));
        N_lines.push(new Line('N', 'N', 'subway-yellow', '#FCCC0A', '#000000'));
        N_lines.push(new Line('Q', 'Q', 'subway-yellow', '#FCCC0A', '#000000'));
        N_lines.push(new Line('R', 'R', 'subway-yellow', '#FCCC0A', '#000000'));
        N_lines.push(new Line('S-1', 'S', 'subway-gray', '#808183', '#FFFFFF'));
        N_lines.push(new Line('S-2', 'S', 'subway-gray', '#808183', '#FFFFFF'));
        N_lines.push(new Line('S-3', 'S', 'subway-gray', '#808183', '#FFFFFF'));
        N_lines.push(new Line('Z', 'Z', 'subway-brown', '#996633', '#FFFFFF'));
        N_lines.push(new Line('1', '1', 'subway-red', '#EE352E', '#FFFFFF'));
        N_lines.push(new Line('2', '2', 'subway-red', '#EE352E', '#FFFFFF'));
        N_lines.push(new Line('3', '3', 'subway-red', '#EE352E', '#FFFFFF'));
        N_lines.push(new Line('4', '4', 'subway-green', '#00933C', '#FFFFFF'));
        N_lines.push(new Line('5', '5', 'subway-green', '#00933C', '#FFFFFF'));
        N_lines.push(new Line('6', '6', 'subway-green', '#00933C', '#FFFFFF'));
        N_lines.push(new Line('7', '7', 'subway-purple', '#B933AD', '#FFFFFF'));
        N_lines.push(new Line('SIRR', 'SI', 'subway-blue', '#0039A6', '#FFFFFF'));
        N_lines.push(new Line('AirTrain JFK', '&#9992;', 'subway-light-yellow', '#FFF200', '#000000'));
        N_lines.push(new Line('AirTrain LGA', '&#9992;', 'subway-light-yellow', '#FFF200', '#000000'));
        N_lines.push(new Line('T', 'T', 'subway-turquoise', '#1E9DBF', '#FFFFFF'));
        N_lines.push(new Line('BQX', 'BQX', 'subway-black', '#212121', '#FFFFFF'));

        N_active_line = find_line_by_name('A');

        N_line_groups = [];
        N_line_groups.push(new LineGroup('ACE', [find_line_by_name('A').id, find_line_by_name('C').id, find_line_by_name('E').id]));
        N_line_groups.push(new LineGroup('BDFM', [find_line_by_name('B').id, find_line_by_name('D').id, find_line_by_name('F').id, find_line_by_name('M').id]))
        N_line_groups.push(new LineGroup('G', [find_line_by_name('G').id]));
        N_line_groups.push(new LineGroup('JZ', [find_line_by_name('J').id, find_line_by_name('Z').id]));
        N_line_groups.push(new LineGroup('L', [find_line_by_name('L').id]));
        N_line_groups.push(new LineGroup('NQR', [find_line_by_name('N').id, find_line_by_name('Q').id, find_line_by_name('R').id]));
        N_line_groups.push(new LineGroup('Shuttles', [find_line_by_name('S-1').id, find_line_by_name('S-2').id, find_line_by_name('S-3').id]));
        N_line_groups.push(new LineGroup('123', [find_line_by_name('1').id, find_line_by_name('2').id, find_line_by_name('3').id]));
        N_line_groups.push(new LineGroup('456', [find_line_by_name('4').id, find_line_by_name('5').id, find_line_by_name('6').id]));
        N_line_groups.push(new LineGroup('7', [find_line_by_name('7').id]));
        N_line_groups.push(new LineGroup('SIRR', [find_line_by_name('SIRR').id]));
        N_line_groups.push(new LineGroup('AirTrains', [find_line_by_name('AirTrain JFK').id, find_line_by_name('AirTrain LGA').id]));
        N_line_groups.push(new LineGroup('T', [find_line_by_name('T').id]));
        N_line_groups.push(new LineGroup('BQX', [find_line_by_name('BQX').id]));
        
        

    }

    initialize_game_state();

    function calculateTotalRidership() {
        var r = 0;
        for (var i = 0; i < N_stations.length; i++) {
            if (N_stations[i].active)
                r += N_stations[i].riders;
        }
        $('#system-ridership').text(Math.round(r).toString());

        var mc_cost = N_stations.length*1000000.0/r;
        $('#metrocard-cost').text("$"+Number(mc_cost).toFixed(2).toString());
    }

    map.on('click', handle_map_click);

    

    </script>
</body>
</html>
