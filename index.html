
<!DOCTYPE html>
<html>
<head>
    <title>Robert Moses Game</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    
    <link rel="stylesheet" href="style.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/leaflet/1.0.0-rc.1/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/leaflet/1.0.0-rc.1/leaflet-src.js"></script>

    <script src="https://cdn.jsdelivr.net/leaflet.esri/2.0.0-beta.8/esri-leaflet.js"></script>
    
</head>
<body>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/leaflet.esri.geocoder/2.0.2/esri-leaflet-geocoder.css">
    <script src="https://cdn.jsdelivr.net/leaflet.esri.geocoder/2.0.2/esri-leaflet-geocoder.js"></script>

    <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js'></script>
    <link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css' rel='stylesheet' />
    
    <script src="js/leaflet.curve.js"></script>
    <script src='js/leaflet-heat.js'></script>
    <script src='js/leaflet.label.js'></script>
    <script src='js/leaflet-pip/leaflet-pip.js'></script>
    <script src='js/turf.min.js'></script>
    
    <div id="map">
    </div>
    <div id="options">
    Select a Line<br />
    <div class="subway-line subway-clickable subway-blue subway-selected"><div class="height_fix"></div><div class="content">A</div></div>
    <div class="subway-line subway-clickable subway-blue"><div class="height_fix"></div><div class="content">C</div></div>
    <div class="subway-line subway-clickable subway-blue"><div class="height_fix"></div><div class="content">E</div></div><br />
    <div class="subway-line subway-clickable subway-orange"><div class="height_fix"></div><div class="content">B</div></div>
    <div class="subway-line subway-clickable subway-orange"><div class="height_fix"></div><div class="content">D</div></div>
    <div class="subway-line subway-clickable subway-orange"><div class="height_fix"></div><div class="content">F</div></div>
    <div class="subway-line subway-clickable subway-orange"><div class="height_fix"></div><div class="content">M</div></div><br />
    <div class="subway-line subway-clickable subway-light-green"><div class="height_fix"></div><div class="content">G</div></div><br />
    <div class="subway-line subway-clickable subway-brown"><div class="height_fix"></div><div class="content">J</div></div>
    <div class="subway-line subway-clickable subway-brown"><div class="height_fix"></div><div class="content">Z</div></div><br />
    <div class="subway-line subway-clickable subway-silver"><div class="height_fix"></div><div class="content">L</div></div><br />
    <div class="subway-line subway-clickable subway-yellow"><div class="height_fix"></div><div class="content">N</div></div>
    <div class="subway-line subway-clickable subway-yellow"><div class="height_fix"></div><div class="content">Q</div></div>
    <div class="subway-line subway-clickable subway-yellow"><div class="height_fix"></div><div class="content">R</div></div><br />
    <div class="subway-line subway-clickable subway-gray"><div class="height_fix"></div><div class="content">S</div></div><br />
    <div class="subway-line subway-clickable subway-red"><div class="height_fix"></div><div class="content">1</div></div>
    <div class="subway-line subway-clickable subway-red"><div class="height_fix"></div><div class="content">2</div></div>
    <div class="subway-line subway-clickable subway-red"><div class="height_fix"></div><div class="content">3</div></div><br />
    <div class="subway-line subway-clickable subway-green"><div class="height_fix"></div><div class="content">4</div></div>
    <div class="subway-line subway-clickable subway-green"><div class="height_fix"></div><div class="content">5</div></div>
    <div class="subway-line subway-clickable subway-green"><div class="height_fix"></div><div class="content">6</div></div><br />
    <div class="subway-line subway-clickable subway-purple"><div class="height_fix"></div><div class="content">7</div></div><br />
    <div class="subway-line subway-clickable subway-blue"><div class="height_fix"></div><div class="content">SI</div></div>
    <div class="subway-line subway-clickable subway-imaginary subway-turquoise"><div class="height_fix"></div><div class="content">T</div></div>
    <div class="subway-line subway-clickable subway-imaginary subway-black"><div class="height_fix"></div><div class="content">BQX</div></div><br />

    <div id="route-diagram">
    </div>

    </div>
    
    
    <div id="system-status">
        <div id="metrocard">
        <i class="fa fa-credit-card" aria-hidden="true"></i>
        <span id="metrocard-cost"></span>
        </div>
        <div id="ridership">
        <i class="fa fa-user" aria-hidden="true"></i>
        <span id="system-ridership"></span>
        </div>
        <div id="game-save" class="game-button">Save</div>
    </div>
    
    <script>
    
    var mapbox_token = 'pk.eyJ1IjoianB3cmlnaHQwIiwiYSI6ImNpbjZ1Y212aTA2dGR1ZGtzNHNxZWRkdjIifQ.OgGN3EIjNNB8JsbNRXqqAg';

    var station_layer = L.featureGroup();
    var curve_layer = L.featureGroup();
    
    var geo_range_lat = 0.8;
    var geo_range_lon = 1.0;

    var lat_min = 40.713 - geo_range_lat/2.0;
    var lat_max = 40.713 + geo_range_lat/2.0;
    var lon_min = -74.006 - geo_range_lon/2.0;
    var lon_max = -74.006 + geo_range_lon/2.0;

    var voxels_dim = 500;
    var voxels_res_lat = geo_range_lat / voxels_dim;
    var voxels_res_lon = geo_range_lon / voxels_dim;
    var voxels_total = voxels_dim * voxels_dim;
    
    var map = L.map('map', {
        fullscreenControl: true,
    }).setView([40.713, -74.006], 13);

    curve_layer.setZIndex(2).addTo(map);
    station_layer.setZIndex(3).addTo(map);
    
    map.addLayer(curve_layer);
    map.addLayer(station_layer);
    
    //L.control.scale().addTo(map);
    
    var tiles = L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token='+mapbox_token, {
        maxZoom: 18,
        attribution: '',
        id: 'mapbox.light'
    }).addTo(map);

    var neighborhoods = new L.geoJson();
    //neighborhoods.addTo(map);

    $.ajax({
        dataType: "json",
        url: "geojson/neighborhoods.geojson",
        success: function(data) {
            $(data.features).each(function(key, data) {
                neighborhoods.addData(data);
            });
        }
    }).error(function() {});
    
    var landmarks = new L.geoJson();
    //landmarks.addTo(map);

    $.ajax({
        dataType: "json",
        url: "geojson/landmarks.geojson",
        success: function(data) {
            $(data.features).each(function(key, data) {
                landmarks.addData(data);
            });
        }
    }).error(function() {});
    
    var tracts = new L.geoJson();
    var tracts_layers;
    var turf_polygons = {};
    
    var population_heat = L.heatLayer([], {radius: 30, max: 0.5, blur: 50}).addTo(map),
        draw = true;
        
    var tract_centroids = {};
    var tract_nearby = {};

    $.ajax({
        dataType: "json",
        url: "geojson/everything_node.min.geojson",
        success: function(data) {
            console.log('Loaded tracts');
            console.log(data);
            $(data.features).each(function(key, data) {
                tracts.addData(data);
                
                var turf_polygon = turf.polygon(data.geometry.coordinates[0]);
                turf_polygons[key] = turf_polygon;
                
                if (turf_polygon.geometry.coordinates[0].length == 3) {
                    var coords = [turf_polygon.geometry.coordinates[0][1], turf_polygon.geometry.coordinates[0][0]];
                } else {
                    var coords = [turf_polygon.geometry.coordinates[0][0][1], turf_polygon.geometry.coordinates[0][0][0]];
                }
                
                //L.marker(coords).bindLabel(data.properties.C).addTo(map);
                
            });
            //tracts.addTo(map);
            
            
            tracts_layers = tracts.getLayers();
            
            
            console.log("Length of tracts array: "+tracts_layers.length);
                
        }
    }).error(function() {});
    
    
    
    $.ajax({
        dataType: "json",
        url: "json/tract_nearby_node.min.json",
        success: function(data) {
            console.log("Loaded tract neighbors");
            tract_nearby = data;
        }
    }).error(function(jqXHR, textStatus, errorThrown) {
        console.log("Error loading tract_nearby_node.json");
        console.log(textStatus);
        console.log(errorThrown);
    });
    
    var populations = {};
    $.getJSON( "json/population.json", function( data ) {
        console.log('Loaded population');
        $.each( data.data, function(key, val ) {
            populations[val[12]] = val[13];
        });
    });
    
    var demand = [];
    $.getJSON( "json/demand.json", function( data ) {
        console.log('Loaded demand');
        demand = data;
        
        for (var i = 200; i < 300; i++) {
            for (var j = 200; j < 300; j++) {
                var bounds = [[lat_min + i*voxels_res_lat, lon_min + j*voxels_res_lon], [lat_min + (i+1)*voxels_res_lat, lon_min + (j+1)*voxels_res_lon]];
                L.rectangle(bounds, {stroke: false, fillOpacity: demand[i][j]/2000.0}).bindLabel("i="+i.toString()+", j="+j.toString()+", d="+demand[i][j].toString(), { noHide: true }).addTo(map);
            }
        }
        
    });
    
    var active_line = 'A';
    
    $('.subway-clickable').click(function() {
        if ($(this).hasClass('subway-selected')) {
            $(this).removeClass('subway-selected');
            active_line = 'None';
        } else {
            $('.subway-clickable').removeClass('subway-selected');
            $(this).addClass('subway-selected');
            active_line = $(this).text();
        }
        regeneratePopups();
	generateRouteDiagram();
    });
    
    $('#game-save').click(function() {
        generateGameJSON();
    });
    
    var next_station_id = 0;
    
    function generateNearbyJSON() {
        var json = [];
        
        json.push(tract_nearby);
        
        //console.log(json);
        
        $("<a />", {
            "download": "tract_nearby.json",
            "href" : "data:application/json," + encodeURIComponent(JSON.stringify(json))
        }).appendTo("body")
        .click(function() {
            $(this).remove()
        })[0].click()
    }
    
    function generateGameJSON() {
        var json = [];
        for (station_index in stations) {
            var station = stations[station_index];
            var station_json = {"name": station["name"], "latlng": (station["marker"].getLatLng().lat, station["marker"].getLatLng().lng), "lines": {}, "riders": station["riders"]};
            for (line_index in station["lines"]) {
                var line = station["lines"][line_index];
                var line_pos = station_associations[line].indexOf(station);
                station_json["lines"][line] = line_pos;
            }
            json.push(station_json);
        }
        //console.log(json);
        $("<a />", {
            "download": "subway-game.json",
            "href" : "data:application/json," + encodeURIComponent(JSON.stringify(json))
        }).appendTo("body")
        .click(function() {
            $(this).remove()
        })[0].click()
    }
    
    function loadGameJSON() {
        $.getJSON( "subway-game.json", function( data ) {
            initializeGameState();
        });
    }
    
    function generateRouteDiagram() {
	var line_stations = station_associations[active_line];
	$('#route-diagram').empty();
	for (i = 0; i < line_stations.length; i++) {
	    var station = line_stations[i];
	    var station_entry = '<div class="route-diagram-entry"><div class="route-diagram-name">'+station['name']+'</div><div class="route-diagram-transfers">';
	    for (j = 0; j < station['lines'].length; j++) {
		if (station['lines'][j] != active_line) {
		    station_entry += '<div class="subway-line-mini '+line_styles[station['lines'][j]]+'"><div class="height_fix"></div><div class="content">'+station['lines'][j]+'</div></div>';
		}
	    }
	    station_entry += '</div></div>';
	    $('#route-diagram').append(station_entry);
	}
    }

    function regeneratePopups() {
        var i;
        for (i = 0; i < stations.length; i++) {
            var stationi = stations[i];
            var popup = generatePopup(i, stationi['name'], stationi['info'], stationi['lines'], stationi['riders']);
            stations[i]['marker'].unbindPopup();
            stations[i]['marker'].bindPopup(popup);
            station_popups[i] = popup;
            
        }
    }
    
    function deleteStation(e) {
    
        
        var station_id = $(this).attr('id').replace('delete-', '');
        var station = stations[station_id];
        
        console.log('Delete station '+station_id);
        
        var delete_classes = $(this).attr('class').split(' ');
        var station_lines = [];
        for (c in delete_classes) {
            if (delete_classes[c].indexOf('line-') > -1) {
                var line = delete_classes[c].replace('line-', '');
                station_lines.push(line);
            }
        }
        station_layer.removeLayer(station['marker']);
        
        stations.splice(station_id,1);
        station_popups.splice(station_id,1);
        
        regeneratePopups();
        
        for (line_index in station_lines) {
            var line = station_lines[line_index];
            var li = station_associations[line].indexOf(station);
            if (li > -1) {
                station_associations[line].splice(li, 1);
                
                drawCurves(line);
            }
        }

	generateRouteDiagram();
	calculateTotalRidership();
            
    }
    
    function buildToStation(e) {
    
        
        var station_id = $(this).attr('id').replace('build-', '');
        var station = stations[station_id];
        
        
        console.log('Build to station '+station_id);
        
        var build_classes = $(this).attr('class').split(' ');
        var station_lines = [];
        for (c in build_classes) {
            if (build_classes[c].indexOf('line-') > -1) {
                var line = build_classes[c].replace('line-', '');
                station_lines.push(line);
            }
        }
        
        
        for (line_index in station_lines) {
            var line = station_lines[line_index];
            
            station['lines'].push(line);
	    var insertion_point = findInsertionPoint(line, station);
            station_associations[line].splice(insertion_point, 0, station);
            $('div.subway-lines').append('<div class="subway-line '+line_styles[line]+'"><div class="height_fix"></div><div class="content">'+line+'</div></div>');            
            drawCurves(line);
        }
	station['lines'] = station['lines'].sort();        
        stations[station_id] = station;
        
        regeneratePopups();
        generateRouteDiagram();
    }
    
    $(document).on('click', '.station-delete', deleteStation);
    
    $(document).on('click', '.station-build', buildToStation);
    
    $(document).on('click', '.station-name', function() {
        var text = $(this).text();
        var sn = $(this);
        $(this).text('');
        $('<textarea class="station-name-edit"></textarea>').appendTo($(this)).val(text).select().blur(

        function() {
            var newText = $(this).val();
            $(this).parent().text(newText).find('textarea').remove();
            var station_id = sn.attr('id').replace('station-', '');
            var station = stations[station_id];
            stations[station_id]['name'] = newText;
            var popup = generatePopup(station_id, station['name'], station['info'], station['lines']);
            
            stations[station_id]['marker'].unbindPopup();
            stations[station_id]['marker'].bindPopup(popup);
            station_popups[station_id] = popup;
            generateRouteDiagram(); 
        });
    });

    var popup = L.popup();
    //var circle = L.circleMarker();
    
    var geocodeService = L.esri.Geocoding.geocodeService();
    
    function cleanAddress(addr) {
        addr = addr.replace(/(\d*-?\d*)\s/g, " ").trim().replace(/^[NWES]\s/g, "");
        addr = addr.replace("Plz", "Plaza");
        addr = addr.trim();
        return addr;
    }
    
    function cleanCity(city) {
        city = city.replace(" Town of", "");
        city = city.replace(" Twp", "");
        city = city.trim();
        return city;
    }

    function findInsertionPoint(active_line, station_obj) {
	var line_insertion_pos = 0;
        var line_insertion_best = -1;
	var line_length = station_associations[active_line].length;
	if (line_length > 0) {
	/*for (var q = 0; q <= line_length; q++) {
	    var total_distance = 0;
	    if (q == 0) {
	    	var test_st = station_associations[active_line][q]['marker'].getLatLng();
            	total_distance = 0.9*Math.pow((Math.pow(latlng_orig.lat - test_st.lat, 2) + Math.pow(latlng_orig.lng - test_st.lng, 2)), 0.5);
	    } else if (q == line_length) {
	        var test_st = station_associations[active_line][q-1]['marker'].getLatLng();
		total_distance = 0.9*Math.pow((Math.pow(latlng_orig.lat - test_st.lat, 2) + Math.pow(latlng_orig.lng - test_st.lng, 2)), 0.5);
	    } else {
	        var test_st = station_associations[active_line][q]['marker'].getLatLng();
		var distance_prev = Math.pow((Math.pow(latlng_orig.lat - test_st.lat, 2) + Math.pow(latlng_orig.lng - test_st.lng, 2)), 0.5);
	        test_st = station_associations[active_line][q-1]['marker'].getLatLng();
		var distance_next = Math.pow((Math.pow(latlng_orig.lat - test_st.lat, 2) + Math.pow(latlng_orig.lng - test_st.lng, 2)), 0.5);
	        total_distance = Math.min(distance_prev, distance_next);
	    }
	    console.log(total_distance.toString() + " distance at pos "+q.toString());
	    if (total_distance < line_insertion_best || line_insertion_best == -1) {
		line_insertion_pos = q;
		line_insertion_best = total_distance;
	    }
	}*/
	var clone = station_associations[active_line].slice(0);
	var line_insertion_best = -1;
	var line_insertion_pos = 0;
	for (var q = 0; q <= line_length; q++) {
	    clone.splice(q, 0, station_obj);
	    // Compute total distance
	    var total_distance = 0;
	    for (var r = 1; r <= line_length; r++) {
	        var st_prev = clone[r-1]['marker'].getLatLng();
	        var st_next = clone[r]['marker'].getLatLng();
		total_distance += Math.pow((Math.pow(st_prev.lat - st_next.lat, 2) + Math.pow(st_prev.lng - st_next.lng, 2)), 0.5);
	    }
	    if (total_distance < line_insertion_best || line_insertion_best == -1) {
		line_insertion_pos = q;
		line_insertion_best = total_distance;
	    }			
	    clone = station_associations[active_line].slice(0);
	}
	}
	return line_insertion_pos;
    }
    
    var prev_coord = [L.latLng(0, 0), L.latLng(0,0)];

    var stations = [];
    var station_popups = [];
    var station_associations = {};
    var curves = {};
    
    function initializeGameState() {
        stations = [];
        station_popups = [];
        station_associations = {'A': [], 'B': [], 'C': [], 'D': [], 'E': [], 'F': [], 'G': [], 'J': [], 'L': [], 'M': [], 'N': [], 'Q': [], 'R': [], 'S': [], 'Z': [], '1': [], '2': [], '3': [], '4': [], '5': [], '6': [], '7': [], 'SI': [], 'T': [], 'BQX': []};   
        curves = {'A': [], 'B': [], 'C': [], 'D': [], 'E': [], 'F': [], 'G': [], 'J': [], 'L': [], 'M': [], 'N': [], 'Q': [], 'R': [], 'S': [], 'Z': [], '1': [], '2': [], '3': [], '4': [], '5': [], '6': [], '7': [], 'SI': [], 'T': [], 'BQX': []};
    }
    
    initializeGameState();
    
    var line_colors = {'A': '#0039A6', 'B': '#FF6319', 'C': '#0039A6', 'D': '#FF6319', 'E': '#0039A6', 'F': '#FF6319', 'G': '#6CBE45', 'J': '#996633', 'L': '#A7A9AC', 'M': '#FF6319', 'N': '#FCCC0A', 'Q': '#FCCC0A', 'R': '#FCCC0A', 'S': '#808183', 'Z': '#996633', '1': '#EE352E', '2': '#EE352E', '3': '#EE352E', '4': '#00933C', '5': '#00933C', '6': '#00933C', '7': '#B933AD', 'SI': '#0039A6', 'T': '#1E9DBF', 'BQX': '#212121'};
    var line_styles = {'A': 'subway-blue', 'B': 'subway-orange', 'C': 'subway-blue', 'D': 'subway-orange', 'E': 'subway-blue', 'F': 'subway-orange', 'G': 'subway-light-green', 'J': 'subway-brown', 'L': 'subway-silver', 'M': 'subway-orange', 'N': 'subway-yellow', 'Q': 'subway-yellow', 'R': 'subway-yellow', 'S': 'subway-gray', 'Z': 'subway-brown', '1': 'subway-red', '2': 'subway-red', '3': 'subway-red', '4': 'subway-green', '5': 'subway-green', '6': 'subway-green', '7': 'subway-purple', 'SI': 'subway-blue', 'T': 'subway-turquoise', 'BQX': 'subway-black'};
    
    function calculateTotalRidership() {
        var r = 0;
        for (i in stations) {
            r += stations[i]['riders'];
        }
        $('#system-ridership').text(Math.round(r).toString());
        
        var mc_cost = stations.length*1000000.0/r;
        $('#metrocard-cost').text("$"+Number(mc_cost).toFixed(2).toString());
    }
    
    function generatePopup(station_id, station_name, station_info, lines, ridership) {
        var station_popup = L.popup({'className': 'station-popup'});
        var station_content = '<div class="station-name" id="station-'+station_id+'">'+station_name+'   <i class="fa fa-pencil" style="margin-left: 5px;" aria-hidden="true"></i></div>';
        station_content += '<div class="station-content"><div class="station-info">'+station_info+'<br /><i class="fa fa-user" aria-hidden="true"></i> '+Math.round(ridership).toString()+'</div>';
        station_content += '<div class="station-info subway-lines">';
        for (i in lines) {
            var line = lines[i];
            station_content += '<div class="subway-line '+line_styles[line]+'"><div class="height_fix"></div><div class="content">'+line+'</div></div>';
        }
        station_content += '</div>';
        
        for (line_index in line_styles) {
            if (lines.indexOf(line_index) == -1 && line_index == active_line) {
                station_content += '<div class="station-content-button station-build line-'+line_index+'" id="build-'+station_id+'">Build <div class="subway-line-mini '+line_styles[line_index]+'"><div class="height_fix"></div><div class="content">'+line_index+'</div></div></div>';
            }
        }
        
        station_content += '<div class="station-content-button station-delete ';
        for (i in lines) {
            var line = lines[i];
            station_content += 'line-'+line+' ';
        }
        station_content += '" id="delete-'+station_id+'">Delete</div>';
        station_content += '</div>';
        station_popup.setContent(station_content);
        return station_popup;
    }
    
    map.on('click', handleMapClick);
    
    function drawCurves(line) {
    
        for (var i = 0; i < curves[line].length; i++) {
            curve = curves[line][i];
            
            map.removeLayer(curve);
        }
        curves[line] = [];
        var i;
        var cp_lat;
        var cp_lng;
        var curve_options = {color: line_colors[line], weight: 8, fill: false};
        for (i = 1; i < station_associations[line].length; i++) {
            var st_prev = station_associations[line][i-1]['marker'].getLatLng();
            var st_curr = station_associations[line][i]['marker'].getLatLng();
            if (i == 2) {
                var st_dir = station_associations[line][i-2]['marker'].getLatLng();
                cp_lat = st_dir.lat;
                cp_lng = st_dir.lng;
            }
            if (i > 1) {
                cp_lat = st_prev.lat + (st_prev.lat - cp_lat)*0.3;
                cp_lng = st_prev.lng + (st_prev.lng - cp_lng)*0.3;
                curve = L.curve(['M', [st_prev.lat, st_prev.lng], 'Q', [cp_lat, cp_lng], [st_curr.lat, st_curr.lng]], curve_options);
            } else {
                curve = L.curve(['M', [st_prev.lat, st_prev.lng], 'L', [st_curr.lat, st_curr.lng]], curve_options);
            }

            curve_layer.addLayer(curve);
            curves[line].push(curve);
            
            
        }
        
        station_layer.bringToFront();
    }
    
    function calculateRidership(latlng) {
        /*
        var turf_pt = {
            "type": "Feature",
            "properties": {},
            "geometry": {
                "type": "Point",
                "coordinates": [latlng.lng, latlng.lat]
            }
        };
        */
        //var turf_circle = turf.buffer(turf_pt, 0.5, 'miles').features[0];
        
        var tract_index = 0;
        var total_ridership = 0;
        
        var found_tract = false;
        
        // New method: Voxels
        
        
        
        var voxel_i = Math.round((latlng.lat - lat_min)/voxels_res_lat);
        var voxel_j = Math.round((latlng.lng - lon_min)/voxels_res_lon);
        
        console.log("Centered on i="+voxel_i+",j="+voxel_j);
        
        total_ridership += demand[voxel_i][voxel_j+2];
        
        total_ridership += demand[voxel_i+1][voxel_j+1];
        total_ridership += demand[voxel_i][voxel_j+1];
        total_ridership += demand[voxel_i-1][voxel_j+1];
        
        total_ridership += demand[voxel_i+2][voxel_j];
        total_ridership += demand[voxel_i+1][voxel_j];
        total_ridership += demand[voxel_i][voxel_j];
        total_ridership += demand[voxel_i-1][voxel_j];
        total_ridership += demand[voxel_i-2][voxel_j];
        
        total_ridership += demand[voxel_i+1][voxel_j-1];
        total_ridership += demand[voxel_i][voxel_j-1];
        total_ridership += demand[voxel_i-1][voxel_j-1];
        
        total_ridership += demand[voxel_i][voxel_j-2];
        
        // Old method: PIP + Neighbors
        
        /*
        var pip_layer = leafletPip.pointInLayer([latlng.lng, latlng.lat], tracts, true);
        if (pip_layer.length > 0) {
            
            //var layer = tracts_layers[tract_index];
            var layer = pip_layer[0];
            //console.log("Found matching tract: "+layer.feature.properties.C);
            console.log(layer);
            //found_tract = true;
            var nearby_tracts = tract_nearby[tracts_layers.indexOf(layer)];
            //console.log(nearby_tracts);
            var tracts_used = 0;
            var ct_used = [];
            for (nearby_index = 0; nearby_index < nearby_tracts.length; nearby_index++) {
                var nearby_layer = tracts_layers[nearby_tracts[nearby_index]];
                var census_tract = nearby_index;
                var ct2010 = nearby_layer.feature.properties.C;
                //console.log("Checking tract "+ct2010+" at pos "+nearby_tracts[nearby_index]);
                var overlap_polygon = turf.intersect(nearby_layer.feature, turf_circle);
                if (ct_used.indexOf(ct2010) == -1) {
                    if (overlap_polygon != undefined) {
                        tracts_used += 1;
                        //console.log(nearby_layer.feature.properties);
                        var tract_population = populations[ct2010];
                        if (tract_population == 0) {
                            //console.log("Empty tract! "+census_tract);
                        } else {
                            //console.log("Tract "+census_tract+" has population "+tract_population);
                        }
                        //console.log("Tract id "+tract_index.toString());
                        //console.log("Census tract "+nearby_layer.feature.properties.CT2010);
                        //console.log("Population is "+tract_population);
                        var overlap_area = turf.area(overlap_polygon);
                        var tract_area = turf.area(nearby_layer.feature);
                        var ridership = tract_population * overlap_area/tract_area;
                        //console.log("Ridership is "+ridership);
                        total_ridership += ridership;
                    } else {
                        //console.log("Undefined overlap polygon with "+ct2010);
                    }
                    ct_used.push(ct2010);
                } else {
                    //console.log("Already used "+ct2010);
                    //console.log(nearby_layer.feature.properties);
                }
            }
            console.log((100.0*tracts_used/nearby_tracts.length).toString() + "% neighbors used");
        }
        */
        
        return total_ridership;
    }
    
    function handleMapClick(e) {
        console.log('map click');
	var latlng = e.latlng;
	var latlng_orig = e.latlng;
        geocodeService.reverse().distance(500).latlng(latlng).run(function(error, result) {
            var station_name = '';
            var station_info = '';
            var geocode_success = true;
            if (error) {
                console.log(error);
                geocode_success = false;
            } else {
                var geocoded_name = result.address.Address;
                if (geocoded_name == null) {
		    geocoded_name = "";
		}
		var city = result.address.City;
                station_name = cleanAddress(geocoded_name);
		//console.log(geocoded_name + " renamed to " + station_name);                
                if (city != "New York") {
                    station_name = cleanCity(city) + ' - ' + station_name;
                    station_info += cleanCity(city);
                }
                //latlng = result.latlng;
            }

            var enc_boroughs = [];
            var enc_neighborhoods = [];
            var enc_neighborhoods_always_label = ['Astoria'];
            var enc_neighborhoods_only_label = ['Roosevelt Island', 'Governors Island', 'Randall\'s Island', 'North Brother Island', 'South Brother Island', 'Rikers Island', 'John F. Kennedy International Airport', 'Floyd Bennett Field', 'LaGuardia Airport'];
            var enc_landmarks = [];
	    var enc_landmarks_only_label = ['Ellis Island', 'Liberty Island', 'Grand Army Plaza', 'Bartel Pritchard Square', 'Mets-Willets Point'];            
            var neighborhood_in_station_name = false;
            
            var neighborhood_layer = leafletPip.pointInLayer([latlng.lng, latlng.lat], neighborhoods, true);
            if (neighborhood_layer.length > 0) {
                enc_boroughs.push(neighborhood_layer[0].feature.properties.borough);
                enc_neighborhoods.push(neighborhood_layer[0].feature.properties.neighborhood);
            }
            
            if (enc_neighborhoods.length > 0) {
                var enc_borough = enc_boroughs[0];
                var enc_neighborhood = enc_neighborhoods[0];

                if (enc_borough != "Manhattan" && station_name.match(/\d/g)) {
                    station_name = enc_neighborhood + ' - ' + station_name;
                    neighborhood_in_station_name = true;
                } 
                
                for (en in enc_neighborhoods) {
                    if ((enc_neighborhoods_always_label.indexOf(enc_neighborhoods[en]) != -1) && !neighborhood_in_station_name) {
                        station_name = enc_neighborhoods[en] + ' - ' + station_name;
                        neighborhood_in_station_name = true;
                    }
                    if ((enc_neighborhoods_only_label.indexOf(enc_neighborhoods[en]) != -1) && !neighborhood_in_station_name) {
                        station_name = enc_neighborhoods[en];
                        neighborhood_in_station_name = true;
                    }
                }
                
                if (!geocode_success) {
                    station_name = enc_neighborhood;
                }
                station_info += enc_borough;
                station_info += '<br />';
                station_info += enc_neighborhood;
            }
            var landmark_layer = leafletPip.pointInLayer([latlng.lng, latlng.lat], landmarks, true);
            if (landmark_layer.length > 0) {
                enc_landmarks.push(landmark_layer[0].feature.properties.name);
            }
            if (enc_landmarks.length > 0) {
                station_name = station_name + ' - ' + enc_landmarks[0];
		if (enc_landmarks_only_label.indexOf(enc_landmarks[0]) != -1) {
		     station_name = enc_landmarks[0];
		}
            }
            
            
            var ridership = calculateRidership(latlng_orig);
            //console.log(ridership);
            
            station = L.circleMarker(latlng_orig, {color: "black", opacity: 1.0, fillColor: "white", fillOpacity: 1.0}).setRadius(6);
            var station_id = stations.length;
            var station_popup = generatePopup(station_id, station_name, station_info, [active_line], ridership);
            
            if (active_line != "None") {
                station.on('click', function(s_e) {
                    
                    // Disable new station creation.
                    map.off('click', handleMapClick);
                    
                    // Wait a second before you can create a new station.
                    setTimeout(function() {
                        map.on('click', handleMapClick);
                    }, 1000);
                });
                //station.addTo(station_layer);

                
                var station_obj = {"marker": station, "name": station_name, "info": station_info, "lines": [active_line], "riders": ridership};
                stations.push(station_obj);
		var line_insertion_pos = findInsertionPoint(active_line, station_obj);
                station_associations[active_line].splice(line_insertion_pos, 0, station_obj);
                
                
                drawCurves(active_line);
                
                station_layer.addLayer(station);
                station_layer.bringToFront();
                station_popups.push(station_popup);
                station.bindPopup(station_popup).openPopup();
            }

	    generateRouteDiagram();
	    calculateTotalRidership();

        });
    }

    </script>
</body>
</html>
